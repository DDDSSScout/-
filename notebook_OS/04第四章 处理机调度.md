## 处理机调度管理的目的:

==**是对CPU资源进行合理的分配使用，<font color=red>以提高处理机利用率</font>，并使各用户<font color=red>公平地</font>得到处理机资源**==。这里的主要问题是**处理机调度算法**和调度算法特征分析。

## 4.1分级调度

### 衡量调度策略的常用指标：

1. **周转时间**：作业提交计算机到返回用户的时间。（尽量要短）
2. **吞吐率**：在给定的时间内，计算机系统完成的总工作量。
3. **响应时间**：用户发送指令给计算机到计算机返回结果给用户的时间。（越短越好）
4. **设备利用率**：输入输出设备的使用情况。

### 4.1.1作业的状态及其转换

一个作业从提交给计算机系统到执行结束退出系统，一般经历**提交、收容、执行和完成**等四个状态。

**提交状态**：一个作业在其处于从输入设备进入外部存储设备的过程。处于提交状杰的作业，因其信息尚未全部进入系统，所以不能被调度程序选取。

**收容状态**：也称为后备状态。输入管理系统不断地将作业输入到外存中对应部分（或称输入井，即专门用来存放待处理作业信息的一组外存分区）。若一个作业的全部信息已全部被输入进输入井，那么，在它还未被调度去执行之前，该作业处于收容状态。

**执行状态**：作业调度程序从后备作业中选取若干个作业到内存投入运行。它为被选中作业建立进程并分配必要的资源，这些被选中的作业则处于执行状态。

**完成状态**：作业运行完毕，但它所占用的资源尚未全部被系统回收时，该作业处于完成状态。在这种状态下，系统需做诸如打印结果、回收资源等类的善后处理工作。

![image-20210927175434002](04%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E5%A4%84%E7%90%86%E6%9C%BA%E8%B0%83%E5%BA%A6.assets/image-20210927175434002.png)

### 4.1.2调度的层次

**作业调度**：**又称为“宏观调度”、“高级调度”**。

**交换调度**：**又称为“中级调度”**。

**进程调度**：**又称为“微观调度”、“低级调度”。按照某种策略和方法选取一个处于就绪状态的进程占用处理机。** 

**线程调度**：**进程内调度--多个并发执行线程**。（让其中一个进程占有CPU）

### 4.1.3作业与进程的关系

**作业是用户向计算机提交的任务实体**，例如一次计算、一个控制过程等。反过来，**进程则是计算机为了完成用户任务实体而设置的执行实体**，是系统分配资源的基本单位。 

一个作业总是由**一个以上的多个进程组成的**。

**作业分解：**

首先，系统必须为一个作业创建一个**根进程**。

然后，在执行作业控制语句时，根据任务要求，系统或根进程为其创建相应的**子进程**。（可能存在子子进程）

为各子进程**分配资源并调度子进程执行**以完成作业要求的任务。 

## 4.2作业调度

### 4.2.1作业调度功能

- **记录系统中各作业的状况**；
- **从后备队列中挑选**出一部分作业投入执行；
- 为被选中作业**做好执行前的准备**工作；
- 在作业执行结束时**做善后处理**工作。

### 4.2.2作业调度目标

- 对所有作业应该是**公平**合理的；
- 应使设备有**高的利用率**；
- 每天执行尽可能**多的作业**；
- 有**快的响应时间**。

### 4.2.3作业性能衡量

> **注意：对于分时系统，仅仅用周转时间或带权周转时间来衡量调度是不够的，还应保证有用户能够容忍的响应时间**。因为对于分时系统，除了要保证系统吞吐量大、资源利用率高之外，还应保证有用户能够容忍的响应时间。

1. #### 周转时间

   作业i的周转时间T~i~=T~ei~-T~si~；

   T~ei~未作业i的完成时间，T~si~为作业的提交时间。一个作业的周转时间说明了该作业在系统内停留的时间，包含两部分：**等待时间** 和 **执行时间**，即：

    ==T~i~=T~wi~+T~ri~==

   T~wi~指作业由后备状态到执行状态的等待时间。

2. #### 带权周转时间

   带权周转时间是作业周转时间与作业执行时间的比：

   W~i~=T~i~/T~ri~

## 4.3进程调度

### 4.3.1进程调度功能

- 记录所有进程的运行状况（静态和动态）;

- 当进程出让CPU或调度程序剥夺执行状态进程占用的CPU时，选择适当的进程分派CPU。

- 完成进程上下文切换

  °检查是否可以进行上下文切换(时机)；

  °保留被切换出CPU的进程上下文(准备)；

  °装配被选择运行进程的上下文(切换)。

### 4.3.2进程调度的时机

1. 引起进程调度的原因有以下几类 ：

   °进程**执行完毕**;

   °进程自己调用**阻塞原语**进入睡眠状态；

   °进程调用了**P原语操作**，因资源不足而被阻塞或调用了**v原语操作**激活了等待资源的进程队列;

   °进程提出**I/O请求后被阻塞**；

   °**时间片**已经用完;

   °系统**调用返回**用户进程时，可看作系统进程执行完毕，从而可调度一新的用户进程执行。

2. **当CPU执行方式是==可剥夺==时**，还有：

   就绪队列中的某进程的**优先级变得高于当前进程**的优先级，也将引发进程调度。

   > 可剥夺式：即就绪队列中一旦有优先级高于当前运行进程优先级的进程存在时，便立即进行进程调度，转让CPU。
   >
   > 意义：①处理紧急事件；②严格区分优先级时

### 4.3.3进程调度性能评价

进程调度性能衡量方法分为：**定形**和**定量**两种

#### 定性衡量

- 调度的可靠性
- 调度的简洁性 

#### 定量评价

- **CPU的利用率评价、进程在**就绪队列中的等待时间与执行时间之比等；
- 模拟或测试**系统响应时间**方法来评估.

## 4.4调度算法

调度算法种类：

1. 先来先服务 
2. 轮转算法 
3. 多级反馈轮转算法 
4. 优先级法
5. 最短作业优先法
6. 最高响应比优先法

### 4.4.1先来先服务（FCFS，First Come First Serve）

最简单的调度算法，按先后顺序进行调度。不利于**执行时间短**的进程

<table><tr><td bgcolor=Cornsilk><b>非抢占</b>：一旦进入运行状态，就不会终止直到运行结束。</br><b>抢占</b>：当前正在运行的进程可以被打断，并转移到就绪态。</td></tr></table>

#### 算法：

- 按照作业提交或进程变为**就绪状态的先后次序**，**分派CPU**。
- 当前作业或进程占用CPU，直到**执行完或阻塞**，**才出让CPU**（非抢占方式）。
- 在作业或进程唤醒后（如I/O完成），并不立即恢复执行，通常等到当前作业或**进程出让CPU**。

####   特点：

- 比较有利于长作业，而不利于短作业。 
- 有利于CPU繁忙的作业，而不利于I/O繁忙的作业。

### 4.4.2轮转法（RR）

让每个进程在就绪队列中等待时间与享受服务时间成正比例。

主要用于**分时系统**，它具有较好的响应时间，且对每个进程来说都具有较好的公平性。

#### 算法：

- 将系统中所有的**就绪进程按照FCFS原则，排成一个队列**。
- 每次调度时将**CPU分派给队首进程**，让其执行一个时间片。时间片的长度从几个ms到几百ms。
- 在**一个时间片结束时，发生时钟中断**。调度程序据此暂停当前进程的执行，将其送到就绪队列的末尾，并通过上下文切换执行当前的队首进程。
- 进程可以**未使用完一个时间片，就出让CPU**（如阻塞）。

![image-20210927182144552](04%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E5%A4%84%E7%90%86%E6%9C%BA%E8%B0%83%E5%BA%A6.assets/image-20210927182144552.png)

#### 时间片长度变化的影响

- ==过长－>退化为FCFS算法==，进程在1个时片内执行完。
- ==过短－>用户的一次请求需要多个时间片才能处理完==，上下文切换次数增加，加重系统开销。

#### 对响应时间要求：

==T(响应时间)=N(进程数目)*q(时间片)==

#### 就绪进程的数目：

==数目越多，时间片越小==。

#### 系统的处理能力：

==应当使**用户输入**通常在一个时间片内能处理完==，否则使响应时间、平均周转时间和平均带权周转时间延长。

### 4.4.3多级反馈轮转法

![image-20210927182516749](04%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E5%A4%84%E7%90%86%E6%9C%BA%E8%B0%83%E5%BA%A6.assets/image-20210927182516749.png)

### 4.4.4优先级法

**系统或用户按某种原则为作业或进程指定一个优先级来表示作业或进程享有的调度优先。**

#### 静态优先级

优先级在生存周期中不变。

- 作业调度优先级 （按作业级别或缴费多少）;
- 进程调度优先级（根据进程类型：I/O , CPU, 均衡型等）

#### 动态优先级

优先级随着作业或进程的执行过程不断的变化。

- 根据进程占用CPU时间的长短来决定;

- 根据就绪进程等待CPU的时间长短来决定。

  优先级 P=a*t（t 为等待时间，a为常数）

### 4.4.5最短作业优先法（Shortest Job First）

#### 算法：

对预计**执行时间短**的作业（进程）优先分派处理机。通常后来的短作业**不抢先**正在执行的作业。 

时间短，代码长：分支语句

时间长，代码短：循环递归

#### 优点：

- 比FCFS改善平均周转时间和平均带权周转时间，缩短作业的等待时间；
- 提高系统的吞吐量；

#### 缺点：

- 对长作业非常不利，可能长时间得不到执行
- 未能依据作业的紧迫程度来划分执行的优先级；
- 难以准确估计作业（进程）的执行时间，从而影响调度性能。

### 4.4.6最高响应比优先法（HRN）

- 最高响应比优先法（Highest Response_ratio Next）调度策略同时考虑每个作业的等待时间长短和估计需要的执行时间长短，从中选出响应比最高的作业投入执行 。
- 响应比R定义如下： R =(W+T)/T = **1+W/T** 
  （T：作业估计需要的执行时间，W：作业就绪队列中等待时间）
- HRN算法是FCFS（几乎没有时间开销，来了就响应）和SJF(最短作业法)之间的折中算法。

## 4.5算法评价



![image-20210927183647701](04%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E5%A4%84%E7%90%86%E6%9C%BA%E8%B0%83%E5%BA%A6.assets/image-20210927183647701.png)

μ：服务率(单位时间里x个顾客被服务的概率)
λ：到达率(单位时间里x个顾客到达的概率)

κ：平均每个顾客的作业需要的时间片个数（完成）
q ：时间片长度

R~fc~：FCFS平均响应时间               
 R~sr~：线性优先级法平均响应时间       
 R~rr~：轮转法平均响应时间  

#### FCFS平均响应时间： 

​		R~fc~(κ) =1/(μ-λ)

#### 轮转法平均响应时间：

​		R~rr~(κ) = κqμ/(μ-λ) 			```与μ、λ成反比```

#### 线性优先级平均响应时间: 

​		R~sr~(κ) = 1/(μ-λ) –(1-κqμ)/(μ-λ)

#### 对于服务时间短顾客：

​			R~rr~ < R~sr~ < R~fc~  			```服务时间短：短时间进程```

#### 对于服务时间长顾客：

​			R~fc~< R~sr~< R~rr~

## 4.6实时系统调度算法

### 4.6.1 实时系统特点

- 把给定的任务，按所**要求的时限**调配到相应的设备上去处理完成

- 实时系统中处理外部事件分为：

  ​	1、硬实时任务(时限绝对满足)  

  ​	2、软实时任务(时限略微可延迟)

- 实时操作系统基本特点：

  ​	1、有限等待时间

  ​	2、有限响应时间

  ​	3、用户控制

  ​	4、可靠性高

  ​	5、系统出错处理能力强

- 实时系统要求实时操作系统具有下述能力：

  1、很快的进程或线程切换速度

  ​	进程或线程切换速度是实时系统设计的核心。

  2、快速的外部中断响应能力

  3、基于优先级的抢先式调度策略

  ​	基于优先级的固定点抢先式调度策略；

  ​	基于优先级的随时抢先式调度策略。 

### 4.6.2 实时调度算法的分类

- 静态表格驱动类

  ​	最早时限优先法：调度时限最早的任务执行。

- 静态优先级驱动抢先式调度算法类

  ​	频率单调调度算法：静态优先级抢占式调度算法。

- 动态计划调度算法类
      执行前排出计划，根据中间状态随时做调整。

- 尽力而为调度算法类
     根据经验给任务指定优先级。

### 4.6.3 时限调度算法与频率单调调度算法

- 时限调度算法

  **按用户的时限要求顺序设置优先级，优先级高者占据处理机**。该算法需要的输入信息：

  ​	任务就绪时间或事件到达时间

  ​	开始时限

  ​	完成时限

  ​	处理时间

  ​	资源需求

  ​	优先级

- 频率单调调度算法
  **基本原理是频率越低(周期越长)的任务的优先级越低。**

<table><tr><td bgcolor=Cornsilk>时限调度算法也可以用于非周期性任务调度。频率单调调度算法是一种被广泛用于多周期性实时处理的调度算法。频率单调调度算法的基本原理是频率越低（周期越长）的任务的优先级越低。设任务周期为T，任务的执行时间为C，则使用频率单调调度算法的必要条件是C≤ T。</td></tr></table>

已经证明，对于n(n≥1)个周期的不同任务来说，设每个周期为T~i~，其相应任务的执行时间为C~i~，则使用频率单调调度算法的**充分条件**是

![image-20210927185424579](04%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E5%A4%84%E7%90%86%E6%9C%BA%E8%B0%83%E5%BA%A6.assets/image-20210927185424579.png)

**如果进程执行时间与周期比之和大于n×(2^1/n^-1)，则用户所要求的时限无法保证。**

## ???

```SRR法是介于FCFS法和RR法之间的一种进程调度方法。```

